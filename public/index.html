<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Q&A</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 600px; 
      margin: auto; 
      padding: 20px; 
      background: linear-gradient(to right, #0F181B, #0D2734); /* Gradient from left to right */
      color: #D7E5D9;
    }

    /* Question input styling */
    #question {
      background-color: #D7E5D9;;
    }

    #username {
      background-color: #D7E5D9;;
    }

    #questions div {
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #D7E5D9;
      min-height: 40px;
    }

    .hidden { 
      display: none; 
    }

    /* Button styling */
    button {
      background-color: #EA0104; /* Red background */
      color: #0D2734; /* Dark text */
      border: none; /* Remove border */
      padding: 10px 20px; /* Add padding */
      text-align: center; /* Center text */
      text-decoration: none; /* Remove underline */
      display: inline-block; /* Inline-block for layout */
      font-size: 1em; /* Font size */
      margin: 5px 0; /* Add margin */
      cursor: pointer; /* Pointer cursor on hover */
      border-radius: 0; /* Rounded corners */
      transition: background-color 0.3s ease; /* Smooth hover effect */
    }

    button:hover {
      background-color: #D7E5D9; /* Light background on hover */
    }

    .question {
      display: flex; /* Enable flexbox */
      align-items: center; /* Vertically center child elements */
      justify-content: space-between; /* Space between text and button */
      padding: 10px;
      border: 1px solid #D7E5D9;
      margin: 10px 0;
    }

    .vote-button {
      padding: 10px 20px;
    }

    .vote-count {
      font-size: .8em;
    }

    .username {
      font-style: italic;
      color: #EA0104;
      font-size: .8em;
    }
  </style>

</head>
<body>
  <h1 id="event-title">VBC</h1>
  <p>To submit a question, just enter a name (optional) and your question and then click the submit button. After review, you should see your question, along with the questions of other students, appear in the "Your Questions" list. If you see a question you are also interested in, just click the vote button under it.</p>

  <div id="participant">
    <textarea id="question" placeholder="Your question..." rows="6" cols="40"></textarea><br>
    <input id="username" placeholder="Enter your name (optional)">
    <button onclick="submitQuestion()">Submit</button>
    <h2>Your Questions</h2>
    <div id="questions"></div>
  </div>

  <hr>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const eventTitle = document.getElementById('event-title');

    // Function to generate a new participant ID
    function generateParticipantID() {
      return 'participant_' + Math.random().toString(36).substr(2, 9);
    }

    // Load values from localStorage
    let storedEventName = localStorage.getItem('eventName');
    let storedEventDatetime = localStorage.getItem('eventDatetime');
    let participantID = localStorage.getItem('participantID');

    // Retrieve the list of voted questions from localStorage
    let votedQuestions = new Set(JSON.parse(localStorage.getItem('votedQuestions')) || []);

    // On page load, set the title to the stored eventName (if available)
    window.addEventListener('load', () => {
      // If no participant ID exists, generate one
      if (!participantID) {
        participantID = generateParticipantID();
        localStorage.setItem('participantID', participantID);
      }

      console.log('Participant ID:', participantID);

      // Set the event title if stored in localStorage
      if (storedEventName) {
        eventTitle.textContent = storedEventName;
      }
    });

    // Listen for the updated event name from the server
    socket.on('event_name_updated', ({ eventName }) => {
      // Check if the eventName has changed
      if (storedEventName !== eventName) {
        storedEventName = eventName;
        localStorage.setItem('eventName', eventName);

        // Generate a new participant ID if the eventName changes
        participantID = generateParticipantID();
        localStorage.setItem('participantID', participantID);

        // Delete previous list of voted questions from localStorage
        localStorage.removeItem('votedQuestions');
        votedQuestions.clear(); // Clear the Set in memory

        // Request the updated list of questions from the server
        socket.emit('request_approved_questions');
      }

      // Update the title in the participant view
      eventTitle.textContent = eventName;
    });

    // Listen for the updated event datetime from the server
    socket.on('event_datetime_updated', ({ eventDatetime }) => {
      // Check if the eventDatetime has changed
      if (storedEventDatetime !== eventDatetime) {
        storedEventDatetime = eventDatetime;
        localStorage.setItem('eventDatetime', eventDatetime);

        // Generate a new participant ID if the eventDatetime changes
        participantID = generateParticipantID();
        localStorage.setItem('participantID', participantID);

        // Delete previous list of voted questions from localStorage
        localStorage.removeItem('votedQuestions');
        votedQuestions.clear(); // Clear the Set in memory

        // Request the updated list of questions from the server
        socket.emit('request_approved_questions');
      }
    });

    let username = ''; // Store the participant's username

    // Submit a question
    function submitQuestion() {
      const username = document.getElementById('username').value;
      const text = document.getElementById('question').value;
      const participantID = localStorage.getItem('participantID'); // Retrieve participant ID from localStorage

      if (text.trim()) {
        // Emit the question to the server with the participant ID
        socket.emit('submit_question', { username, text, participantID });
        document.getElementById('question').value = ''; // Clear the input field
        alert('Your question has been submitted!');
      } else {
        alert('Please enter a question before submitting.');
      }
    }

    // Listen for approved questions from the server
    socket.on('approved_questions', (questions) => {
      updateQuestionList(questions); // Refresh the question list
    });

    socket.on('question_upvoted', (questions) => {
      questions.forEach((updatedQuestion) => {
        // Find the question element in the DOM using its unique ID
        const questionElement = document.querySelector(`.question[data-id="${updatedQuestion.id}"]`);
        if (questionElement) {
          // Update the vote count in the DOM
          const voteCountElement = questionElement.querySelector('.vote-count');
          if (voteCountElement) {
            voteCountElement.textContent = `Votes: ${updatedQuestion.upvotes}`;
          }
        } else {
          // If the question is not in the DOM, add it (e.g., newly approved question)
          const container = document.getElementById('questions');
          const div = document.createElement('div');
          div.className = 'question';
          div.setAttribute('data-id', updatedQuestion.id);
          div.innerHTML = `
            <span>${updatedQuestion.text} | <span class="vote-count">Votes: ${updatedQuestion.upvotes}</span></span>
            <button onclick="vote('${updatedQuestion.id}')">Vote</button>
          `;
          container.appendChild(div);
        }
      });

      // Refresh the list of approved questions
      socket.emit('request_approved_questions');
    });

    // Update the list of approved questions
    function updateQuestionList(questions) {
      const container = document.getElementById('questions');
      container.innerHTML = ''; // Clear the current list

      questions.forEach((q) => {
        const div = document.createElement('div');
        div.className = 'question';
        div.setAttribute('data-id', q.id); // Add a unique identifier for the question

        div.innerHTML = `
          <span>${q.text}<br>
          <span class="username">- ${q.username}</span>
          <span class="vote-count"> | Votes: ${q.upvotes}</span></span>
          ${q.participant_id !== localStorage.getItem('participantID') && !votedQuestions.has(q.id) ? 
            `<button class="vote-button" onclick="vote('${q.id}')">Vote</button>` : ''}
        `;
        container.appendChild(div);
      });
    }

    // Function to handle voting on a question
    function vote(id) {
      if (!votedQuestions.has(id)) {
        socket.emit('upvote', id); // Emit the upvote event to the server
        votedQuestions.add(id); // Mark the question as voted

        // Persist the updated votedQuestions set in localStorage
        localStorage.setItem('votedQuestions', JSON.stringify([...votedQuestions]));
      }
    }
  </script>
</body>
</html>
